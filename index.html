<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Xerox - Multilingual</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --xerox-red: #DA291C; --success-green: #28a745; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f4f4; }
        .container { max-width: 500px; margin: 10px auto; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; min-height: 95vh; display: flex; flex-direction: column; position: relative; }
        
        /* Menu Langue en haut à droite */
        .lang-selector { position: absolute; top: 15px; right: 10px; z-index: 10; }
        .lang-selector select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 0.8em; cursor: pointer; }

        h1 { font-size: 1.3em; margin: 0; color: var(--xerox-red); text-align: center; padding: 25px 50px 15px 15px; background: white; border-bottom: 1px solid #eee; }
        header { background: var(--xerox-red); color: white; padding: 12px; font-weight: bold; }
        .section { padding: 20px; display: none; flex-grow: 1; }
        .active { display: block; }
        .form-group { display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        label { width: 110px; font-weight: bold; font-size: 0.85em; color: #666; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        button { width: 100%; border: none; padding: 15px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .btn-main { background: var(--xerox-red); color: white; margin-top: 15px; }
        .btn-scan { background: #444; color: white; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-manual { background: var(--success-green); color: white; margin-top: 10px; }
        .btn-secondary { background: none; color: #666; text-decoration: underline; margin-top: 15px; }
        .item-list { margin-top: 25px; border-top: 2px solid var(--xerox-red); background: #fdfdfd; padding: 10px; }
        .item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 4px; }
        .item-code { font-family: 'Courier New', monospace; font-weight: bold; color: var(--xerox-red); }
        .item-actions { display: flex; gap: 8px; }
        .btn-icon { background: white; border: 1px solid #ddd; padding: 8px; border-radius: 6px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; }
        .status { padding: 12px; border-radius: 6px; margin-top: 15px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-selector">
        <select id="langSelect" onchange="changeLanguage(this.value)">
            <option value="fr">FR</option>
            <option value="en">EN</option>
        </select>
    </div>

    <h1 id="txt-main-title">Formulaire <br>"Retour de pièces neuves"</h1>
    <header id="headerTitle">1. Informations Expédition</header>

    <div id="step1" class="section active">
        <div class="form-group"><label id="lbl-boxid">BoxID</label><input type="text" id="boxId" maxlength="6" inputmode="numeric"></div>
        <div class="form-group"><label id="lbl-loc">Emplacement</label><input type="text" id="location" placeholder="PD, locker..."></div>
        <div class="form-group"><label id="lbl-tel">Téléphone</label><input type="tel" id="phone" value="418-"></div>
        <div class="form-group"><label id="lbl-empid"># Employé</label><input type="text" id="empId" inputmode="numeric"></div>
        <div class="form-group" style="border:none;"><label id="lbl-email">Votre courriel</label><input type="email" id="userEmail"></div>
        <button class="btn-main" id="btn-next" onclick="saveAndGoToStep2()">Suivant</button>
    </div>

    <div id="step2" class="section">
        <input type="file" accept="image/*" capture="environment" id="fileInput" style="display:none;" onchange="scanFile(this)">
        <button class="btn-scan" id="btn-take-photo" onclick="document.getElementById('fileInput').click()"><i class="fas fa-camera"></i> Prendre Photo</button>
        <div id="reader" style="display:none;"></div>
        <div id="scanStatus" class="status" style="display:none;"></div>
        <button class="btn-manual" id="btn-manual" onclick="manualEntry()">Saisie Manuelle</button>
        <div class="item-list" id="itemList">
            <h3 id="txt-scanned-items" style="font-size: 1em; color: #666;">Pièces scannées (0)</h3>
        </div>
        <button id="sendBtn" class="btn-main" onclick="finalSubmit()">Terminer et Envoyer</button>
        <button class="btn-secondary" id="btn-back" onclick="goToStep(1)">← Retour</button>
    </div>

    <div id="step3" class="section">
        <div style="text-align:center; padding: 40px 20px;">
            <div style="font-size:50px; color:var(--success-green);">✔️</div>
            <p id="txt-success-msg">Données envoyées avec succès !<br><br>ID de transaction généré.<br>Vous recevrez un courriel de confirmation sous peu.</p>
            <button class="btn-main" id="btn-new-form" onclick="resetForm()">Nouveau formulaire</button>
        </div>
    </div>
</div>

<script>
    let inventory = [];
    let currentLang = localStorage.getItem("appLang") || "fr";
    const html5QrCode = new Html5Qrcode("reader");
    const pieceRegex = /^\d{3}[a-zA-Z]\d{5}$/;

    const translations = {
        fr: {
            mainTitle: 'Formulaire <br>"Retour de pièces neuves"',
            header1: "1. Informations Expédition",
            header2: "2. Scan des pièces",
            header3: "Envoi réussi",
            lblBoxId: "BoxID",
            lblLoc: "Emplacement",
            lblTel: "Téléphone",
            lblEmpId: "# Employé",
            lblEmail: "Votre courriel",
            btnNext: "Suivant",
            btnTakePhoto: "Prendre Photo",
            btnManual: "Saisie Manuelle",
            btnSend: "Terminer et Envoyer",
            btnBack: "← Retour",
            btnNew: "Nouveau formulaire",
            itemsTitle: "Pièces scannées",
            statusAnalyzing: "Analyse...",
            statusError: "❌ Code illisible",
            statusAdded: " ajouté",
            alertXerox: "Format Xerox non reconnu",
            alertFields: "BoxID requis (6 chiffres)",
            confirmDel: "Supprimer ?",
            promptQty: "Quantité pour ",
            promptCode: "Code pièce :",
            successMsg: "Données envoyées avec succès !<br><br>ID de transaction généré.<br>Vous recevrez un courriel de confirmation sous peu."
        },
        en: {
            mainTitle: 'Form <br>"New Parts Return"',
            header1: "1. Shipping Info",
            header2: "2. Parts Scanning",
            header3: "Sent Successfully",
            lblBoxId: "BoxID",
            lblLoc: "Location",
            lblTel: "Phone",
            lblEmpId: "Employee #",
            lblEmail: "Your Email",
            btnNext: "Next",
            btnTakePhoto: "Take Photo",
            btnManual: "Manual Entry",
            btnSend: "Finish and Send",
            btnBack: "← Back",
            btnNew: "New Form",
            itemsTitle: "Scanned Parts",
            statusAnalyzing: "Analyzing...",
            statusError: "❌ Unreadable code",
            statusAdded: " added",
            alertXerox: "Xerox format not recognized",
            alertFields: "BoxID required (6 digits)",
            confirmDel: "Delete?",
            promptQty: "Quantity for ",
            promptCode: "Part Code:",
            successMsg: "Data sent successfully!<br><br>Transaction ID generated.<br>You will receive a confirmation email shortly."
        }
    };

    function changeLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("appLang", lang);
        const t = translations[lang];
        
        document.getElementById("txt-main-title").innerHTML = t.mainTitle;
        document.getElementById("lbl-boxid").innerText = t.lblBoxId;
        document.getElementById("lbl-loc").innerText = t.lblLoc;
        document.getElementById("lbl-tel").innerText = t.lblTel;
        document.getElementById("lbl-empid").innerText = t.lblEmpId;
        document.getElementById("lbl-email").innerText = t.lblEmail;
        document.getElementById("btn-next").innerText = t.btnNext;
        document.getElementById("btn-take-photo").innerHTML = `<i class="fas fa-camera"></i> ${t.btnTakePhoto}`;
        document.getElementById("btn-manual").innerText = t.btnManual;
        document.getElementById("sendBtn").innerText = t.btnSend;
        document.getElementById("btn-back").innerText = t.btnBack;
        document.getElementById("txt-success-msg").innerHTML = t.successMsg;
        document.getElementById("btn-new-form").innerText = t.btnNew;
        
        // Mettre à jour le header selon l'étape actuelle
        updateHeader();
        updateList();
    }

    function updateHeader() {
        const step = document.querySelector('.section.active').id;
        const t = translations[currentLang];
        if(step === "step1") document.getElementById("headerTitle").innerText = t.header1;
        if(step === "step2") document.getElementById("headerTitle").innerText = t.header2;
        if(step === "step3") document.getElementById("headerTitle").innerText = t.header3;
    }

    window.onload = function() {
        document.getElementById("langSelect").value = currentLang;
        changeLanguage(currentLang);
        ["phone", "empId", "userEmail"].forEach(id => {
            const val = localStorage.getItem("saved"+id);
            if(val) document.getElementById(id).value = val;
        });
    };

    // --- LOGIQUE EXISTANTE MISE À JOUR ---

    function playSuccessSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.5);
    }

    function saveAndGoToStep2() {
        const boxId = document.getElementById("boxId").value.trim();
        if (!boxId || !/^\d{6}$/.test(boxId)) { alert(translations[currentLang].alertFields); return; }
        localStorage.setItem("savedphone", document.getElementById("phone").value);
        localStorage.setItem("savedempId", document.getElementById("empId").value);
        localStorage.setItem("saveduserEmail", document.getElementById("userEmail").value);
        goToStep(2);
    }

    function goToStep(step) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');
        updateHeader();
    }

    function scanFile(input) {
        if (!input.files?.length) return;
        const status = document.getElementById("scanStatus");
        status.style.display = "block";
        status.innerText = translations[currentLang].statusAnalyzing;
        html5QrCode.scanFile(input.files[0], true)
            .then(text => { addOrUpdatePiece(text); input.value = ""; })
            .catch(err => { 
                status.innerText = translations[currentLang].statusError;
                input.value = ""; 
            });
    }

    function addOrUpdatePiece(code) {
        const cleanCode = code.trim().replace(/\*/g, "").toUpperCase();
        if (pieceRegex.test(cleanCode)) {
            const item = inventory.find(i => i.code === cleanCode);
            if (item) item.qty += 1; else inventory.push({ code: cleanCode, qty: 1 });
            playSuccessSound();
            document.getElementById("scanStatus").innerText = "✅ " + cleanCode + translations[currentLang].statusAdded;
            updateList();
        } else {
            alert(translations[currentLang].alertXerox);
        }
    }

    function updateList() {
        const listDiv = document.getElementById("itemList");
        const t = translations[currentLang];
        listDiv.innerHTML = `<h3 style="font-size: 1em; color: #666;">${t.itemsTitle} (${inventory.length})</h3>`;
        inventory.forEach((item, index) => {
            const row = document.createElement("div"); row.className = "item";
            row.innerHTML = `<div><span class="item-code">${item.code}</span><br><small>QTY: ${item.qty}</small></div>
                <div class="item-actions">
                    <button class="btn-icon" onclick="editQuantity(${index})" style="color:#007bff"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn-icon" onclick="removePiece(${index})" style="color:red"><i class="fas fa-trash"></i></button>
                </div>`;
            listDiv.appendChild(row);
        });
    }

    function editQuantity(i) {
        let valid = false;
        const t = translations[currentLang];
        while (!valid) {
            const n = prompt(t.promptQty + inventory[i].code + " :", inventory[i].qty);
            if (n === null) break;
            const newQty = parseInt(n.trim());
            if (!isNaN(newQty) && newQty > 0) {
                inventory[i].qty = newQty; updateList(); valid = true;
            } else { alert("Error: number required"); }
        }
    }

    function removePiece(i) { if(confirm(translations[currentLang].confirmDel)) { inventory.splice(i, 1); updateList(); } }
    function manualEntry() { const c = prompt(translations[currentLang].promptCode); if (c) addOrUpdatePiece(c); }

    function finalSubmit() {
        if (!inventory.length) return;
        const transactionID = Date.now();
        const btn = document.getElementById("sendBtn");
        btn.disabled = true;

        let body = "ID_TRANSACTION:" + transactionID + "\nDEBUT_DONNEES\n";
        body += "BOXID:" + document.getElementById("boxId").value + "\nEMPID:" + document.getElementById("empId").value + "\n";
        inventory.forEach(i => body += "ITEM:" + i.code + "|QTY:" + i.qty + "\n");
        
        const mailto = "mailto:Power.Automate.Flow.Bot@xerox.com?subject=DATA_SCAN_XEROX_" + transactionID + "&body=" + encodeURIComponent(body + "FIN_DONNEES");
        
        inventory = []; updateList();
        window.location.href = mailto;
        setTimeout(() => { goToStep(3); btn.disabled = false; }, 1500);
    }

    function resetForm() {
        inventory = []; updateList();
        document.getElementById("boxId").value = "";
        document.getElementById("scanStatus").style.display = "none";
        goToStep(1);
    }
</script>
</body>
</html>
