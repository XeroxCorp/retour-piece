<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Xerox Scanner V7 - Zoom</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --xerox-red: #DA291C; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; text-align: center; }
        .container { max-width: 500px; margin: auto; background: white; min-height: 100vh; }
        header { background: var(--xerox-red); color: white; padding: 15px; font-weight: bold; }
        .section { padding: 20px; display: none; }
        .active { display: block; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { width: 90%; padding: 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-main { background: var(--xerox-red); color: white; }
        #reader { width: 100%; margin-top: 15px; background: black; border-radius: 8px; }
        .status { padding: 10px; margin-top: 10px; border-radius: 4px; font-weight: bold; display: none; }
        .status-ok { background: #d4edda; color: #155724; }
        .item { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <header>XEROX SCANNER V7 (ZOOM)</header>

    <div id="step1" class="section active">
        <input type="text" id="boxId" placeholder="BoxID">
        <input type="text" id="location" placeholder="Emplacement">
        <input type="tel" id="phone" placeholder="T√©l√©phone">
        <input type="text" id="empId" placeholder="# Employ√©">
        <input type="email" id="userEmail" placeholder="Courriel">
        <button class="btn-main" onclick="goToStep(2)">Suivant</button>
    </div>

    <div id="step2" class="section">
        <button id="btnStart" class="btn-main" onclick="startScanner()" style="background:#333">üì∑ Activer Cam√©ra Zoom√©e</button>
        <div id="reader"></div>
        <div id="scanStatus" class="status"></div>
        <div id="itemList" style="margin-top:20px; font-weight: bold;">Pi√®ces (0)</div>
        <button class="btn-main" onclick="goToStep(3)">Terminer</button>
    </div>

    <div id="step3" class="section">
        <h2>‚úîÔ∏è Pr√™t</h2>
        <button class="btn-main" onclick="location.reload()">Recommencer</button>
    </div>
</div>

<script>
    let inventory = [];
    let scanner = null;
    const xeroxRegex = /^\d{3}[a-zA-Z]\d{5}$/;

    function goToStep(s) {
        document.querySelectorAll('.section').forEach(div => div.classList.remove('active'));
        document.getElementById('step' + s).classList.add('active');
        if (s !== 2) stopScanner();
    }

    async function startScanner() {
        document.getElementById('btnStart').style.display = 'none';
        scanner = new Html5Qrcode("reader");
        
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 150 } 
        };

        try {
            await scanner.start(
                { facingMode: "environment" }, 
                config, 
                (decodedText) => {
                    let code = decodedText.trim().replace(/\*/g, "").toUpperCase();
                    if (xeroxRegex.test(code)) {
                        inventory.push({code: code});
                        document.getElementById("scanStatus").style.display = "block";
                        document.getElementById("scanStatus").className = "status status-ok";
                        document.getElementById("scanStatus").innerText = "‚úÖ " + code;
                        updateList();
                        stopScanner();
                    }
                }
            );

            // TENTATIVE DE ZOOM APR√àS D√âMARRAGE
            const videoTrack = scanner.getVideoTrack();
            const capabilities = videoTrack.getCapabilities();
            
            // Si le t√©l√©phone supporte le zoom, on le r√®gle sur 2x ou le maximum
            if (capabilities.zoom) {
                await videoTrack.applyConstraints({
                    advanced: [{ zoom: Math.min(2, capabilities.zoom.max) }]
                });
            }
        } catch (err) {
            alert("Erreur: " + err);
            stopScanner();
        }
    }

    function stopScanner() {
        if (scanner) {
            scanner.stop().then(() => {
                document.getElementById('btnStart').style.display = 'block';
            }).catch(() => {});
        }
    }

    function updateList() {
        const div = document.getElementById("itemList");
        div.innerHTML = `Pi√®ces (${inventory.length})`;
        inventory.forEach(item => {
            div.innerHTML += `<div class="item">${item.code}</div>`;
        });
    }
</script>
</body>
</html>
