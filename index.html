<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Xerox Scanner V5</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --xerox-red: #DA291C; --success-green: #28a745; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; }
        .container { max-width: 500px; margin: auto; background: white; min-height: 100vh; display: flex; flex-direction: column; }
        h1 { font-size: 1.2em; color: var(--xerox-red); text-align: center; padding: 15px; margin: 0; border-bottom: 1px solid #ddd; }
        header { background: var(--xerox-red); color: white; padding: 10px; font-weight: bold; }
        .section { padding: 20px; display: none; }
        .active { display: block; }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.8em; font-weight: bold; color: #666; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-main { background: var(--xerox-red); color: white; }
        .btn-scan { background: #333; color: white; }
        #reader { width: 100%; margin-top: 15px; border-radius: 8px; }
        .status { padding: 10px; margin-top: 10px; border-radius: 4px; text-align: center; font-weight: bold; display: none; }
        .status-ok { background: #d4edda; color: #155724; }
        .status-err { background: #fff3cd; color: #856404; }
        .item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <h1>Xerox Retour - V5</h1>
    <header id="headerTitle">1. Infos Exp√©diteur</header>

    <div id="step1" class="section active">
        <div class="form-group"><label>BoxID</label><input type="text" id="boxId"></div>
        <div class="form-group"><label>Emplacement</label><input type="text" id="location"></div>
        <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="phone"></div>
        <div class="form-group"><label># Employ√©</label><input type="text" id="empId"></div>
        <div class="form-group"><label>Courriel</label><input type="email" id="userEmail"></div>
        <button class="btn-main" onclick="goToStep(2)">Suivant</button>
    </div>

    <div id="step2" class="section">
        <button id="btnStart" class="btn-scan" onclick="startScanner()">üì∑ Activer la Cam√©ra</button>
        <div id="reader"></div>
        <div id="scanStatus" class="status"></div>
        
        <button class="btn-main" onclick="manualEntry()" style="background:#28a745">Saisie Manuelle</button>
        <div id="itemList" style="margin-top:20px;"><b>Liste des pi√®ces (0)</b></div>
        
        <button class="btn-main" onclick="goToStep(3)">Terminer et Envoyer</button>
        <button onclick="goToStep(1)" style="background:none; text-decoration:underline; color:#666;">Retour</button>
    </div>

    <div id="step3" class="section" style="text-align:center;">
        <p style="font-size: 50px;">‚úîÔ∏è</p>
        <p>Donn√©es pr√™tes √† √™tre envoy√©es.</p>
        <button class="btn-main" onclick="location.reload()">Nouveau formulaire</button>
    </div>
</div>

<script>
    let inventory = [];
    let scanner = null;
    const xeroxRegex = /^\d{3}[a-zA-Z]\d{5}$/;

    function goToStep(s) {
        document.querySelectorAll('.section').forEach(div => div.classList.remove('active'));
        document.getElementById('step' + s).classList.add('active');
        if (s !== 2) stopScanner();
    }

    function startScanner() {
        document.getElementById('btnStart').style.display = 'none';
        
        // On initialise le scanner SANS forcer de r√©solution complexe
        scanner = new Html5Qrcode("reader");
        
        const config = { 
            fps: 10, 
            qrbox: { width: 280, height: 150 }
        };

        scanner.start(
            { facingMode: "environment" }, 
            config, 
            (decodedText) => {
                // NETTOYAGE DES √âTOILES *
                let code = decodedText.trim().replace(/\*/g, "").toUpperCase();
                const status = document.getElementById("scanStatus");
                status.style.display = "block";

                if (xeroxRegex.test(code)) {
                    inventory.push({code: code, qty: 1});
                    status.className = "status status-ok";
                    status.innerText = "‚úÖ Valid√© : " + code;
                    updateList();
                    stopScanner();
                } else {
                    status.className = "status status-err";
                    status.innerText = "‚ö†Ô∏è Mauvais format : " + code;
                }
            }
        ).catch(err => {
            alert("Erreur cam√©ra : " + err);
            document.getElementById('btnStart').style.display = 'block';
        });
    }

    function stopScanner() {
        if (scanner) {
            scanner.stop().then(() => {
                document.getElementById('btnStart').style.display = 'block';
            }).catch(() => {});
        }
    }

    function updateList() {
        const div = document.getElementById("itemList");
        div.innerHTML = `<b>Liste des pi√®ces (${inventory.length})</b>`;
        inventory.forEach(item => {
            div.innerHTML += `<div class="item"><span>${item.code}</span></div>`;
        });
    }

    function manualEntry() {
        let code = prompt("Code pi√®ce :");
        if (code) {
            let clean = code.replace(/\*/g, "").toUpperCase();
            if (xeroxRegex.test(clean)) {
                inventory.push({code: clean, qty: 1});
                updateList();
            } else { alert("Format invalide"); }
        }
    }
</script>
</body>
</html>
